---
title: 2020-08-12.
---

## 分表分库

### 为什么要做分表分库
在业务量不大时，单库单表即可支撑；当数据量过大存储不下、或者并发量过大负荷不起时，就要考虑分库分表。
那么很明显，并非每个项目都需要做分表分库，但是一个有长远目标的项目一定要考虑分表分库。

### 如何实现分表分库
分库分表相关术语
· 读写分离: 不同的数据库，同步相同的数据，分别只负责数据的读和写；
· 分区: 指定分区列表达式，把记录拆分到不同的区域中(必须是同一服务器，可以是不同硬盘)，应用看来还是同一张表，没有变化；
· 分库：一个系统的多张数据表，存储到多个数据库实例中；
· 分表: 对于一张多行(记录)多列(字段)的二维数据表，又分两种情形： 
  (1) 垂直分表: 竖向切分，不同分表存储不同的字段，可以把不常用或者大容量、或者不同业务的字段拆分出去； 
  (2) 水平分表(最复杂): 横向切分，按照特定分片算法，不同分表存储不同的记录。

### 分表分库需要注意哪些问题
需要注意的是，分库分表会为数据库维护和业务逻辑带来一系列复杂性和性能损耗，除非预估的业务量大到万不得已，切莫过度设计、过早优化。 
规划期内的数据量和性能问题，尝试能否用下列方式解决：
· 当前数据量：如果没有达到几百万，通常无需分库分表；
· 数据量问题：增加磁盘、增加分库(不同的业务功能表，整表拆分至不同的数据库)；
· 性能问题：升级CPU/内存、读写分离、优化数据库系统配置、优化数据表/索引、优化 SQL、分区、数据表的垂直切分；
· 如果仍未能奏效，才考虑最复杂的方案：数据表的水平切分。

### 针对微服务（短链服务）分表分库
1. 根据id分表：
>id % 2 = 0 => tab_a_1
>id % 2 = 1 => tab_b_1
也可考虑根据时间季度或月份分表，但这么分最终create和update压力还是在一张表上。

2. 面对以后需要扩容：
>id % 4 = 0 => tab_a_1
>id % 4 = 1 => tab_b_1
>id % 4 = 2 => tab_a_2
>id % 4 = 3 => tab_b_2
>原先的数据可手动迁移。

3. 若要分表分库，代码层处理
>SaveMessage(user_id, msgctx, addtime)
>#分库
>userid % 4 = N ->DB_N
>#分表
>addtime(range) ->tb_X{0,1,2}
>GetMessage(user_id, touser_id, btime, etime)